# Two-Factor Authentication for Open-WebUI

This document outlines the implementation details and usage of Two-Factor Authentication (2FA) in Open-WebUI.

## Overview

Two-factor authentication adds an additional layer of security by requiring users to provide a second form of verification beyond their password. 
This implementation uses Time-based One-Time Passwords (TOTP) following the RFC 6238 standard, compatible with authenticator apps like Proton Pass, Google Authenticator, Authy, or Microsoft Authenticator.

## Features

- **TOTP Authentication**: Time-based one-time passwords compatible with standard authenticator apps
- **Backup Codes**: One-time use recovery codes for account access if the authenticator app is unavailable
- **User-friendly Setup**: Step-by-step setup process with QR code scanning
- **Strong Authentication**: Sensitive operations (like disabling 2FA) require both password and verification code
- **Cookie-based Authentication Flow**: Secure authentication process for 2FA verification

## Usage Instructions

### Setup Process

1. Log in to your Open-WebUI account
2. Navigate to Account settings
3. Find the "Two-Factor Authentication" section
4. Click the "Setup" button
5. Scan the displayed QR code with your authenticator app (Google Authenticator, Authy, etc.)
6. Enter the 6-digit code shown in your authenticator app to confirm setup
7. Save the provided backup codes in a secure location

### Login Process with 2FA

1. Enter your email and password as usual
2. When prompted, enter the 6-digit code from your authenticator app
3. If you don't have access to your authenticator app, click "Use backup code" and enter one of your backup codes

### Manage 2FA

1. Navigate to Account settings
2. Find the "Two-Factor Authentication" section
3. Click the "Manage" button (only visible when 2FA is enabled)
4. From the management modal, you can:
   - **View Backup Codes**: See your current backup codes (requires password confirmation)
   - **Generate New Backup Codes**: Create new backup codes, invalidating old ones (requires password confirmation)
   - **Disable 2FA**: Turn off two-factor authentication (requires both verification code and password confirmation)


## Admin reset 2FA
1. Navigate to the Admin panel's user overview
2. Click the lock button next to the user edit
3. Confirm disabling 2FA for the user


## Implementation Details

(This review is Auto-generated by Sonnet 3.7 and may not be complete)

### Backend Components

- **Database Fields**: Added to Auth model to store MFA state, TOTP secret, backup codes, etc.
- **Utilities**: Functions for TOTP generation/verification, QR code creation, and backup code management
- **API Endpoints**: Routes for setting up, enabling, verifying, and disabling 2FA
- **Authentication Flow**: Modified sign-in process to handle 2FA verification with partial tokens
- **Cookies and Tokens**: Uses both HttpOnly cookies and Bearer tokens for authentication
- **Security Measures**: Constant-time comparison for security-sensitive operations, standardized error messages
- **Admin Management**: Admin-only endpoints for disabling 2FA for any user in case of lost access

### Frontend Components

- **MFA Setup Modal**: Component for setting up and managing 2FA (`/src/lib/components/MFASetupModal.svelte`)
- **MFA Verify Modal**: Component for entering TOTP or backup codes during login (`/src/lib/components/MFAVerifyModal.svelte`) 
- **API Integration**: Client-side functions for interacting with MFA endpoints (`/src/lib/apis/auths/index.ts`)
- **Account Integration**: Added to Account settings page (`/src/lib/components/chat/Settings/Account.svelte`)
- **Authentication Flow**: Updated to handle the 2FA verification step
- **Admin UI Integration**: Added 2FA status and admin controls to the user management interface (`/src/lib/components/admin/Users/UserList.svelte`)

### Authentication Flow Details

1. **Initial Authentication**:
   - User submits email/password to `/api/v1/auths/signin`
   - If MFA is enabled, a partial token is issued and stored as a cookie
   - Response indicates MFA verification is required

2. **MFA Verification**:
   - User submits TOTP code or backup code to `/api/v1/auths/mfa/verify`
   - Backend verifies the code and issues a full authentication token
   - Token is stored both as an HttpOnly cookie and returned in the response
   - Frontend stores the token in localStorage via `localStorage.token = sessionUser.token`

3. **Subsequent API Calls**:
   - Include the token in both Authorization header and cookies
   - All API fetch calls include `credentials: 'include'` to send cookies
   - Bearer token is sent in headers via `Authorization: Bearer ${token}`

#### Implemented Improvements

1. **Token Format Standardization**:
   - Updated MFA verification endpoint to create tokens with `{"id": user.id}` format to match standard auth
   - Modified partial token to include both `id` and `sub` fields for maximum compatibility
   - Ensured cookie settings match exactly between standard and MFA auth flows
   - Added comprehensive logging throughout the authentication process

2. **Enhanced Error Handling**:
   - Added robust error handling in token decoding with specific error types
   - Standardized error messages to prevent account enumeration
   - Implemented constant-time comparison for backup code verification
   - Added detailed logging for authentication failures for security monitoring

3. **Flexible Authentication Middleware**:
   - Modified `get_current_user` to support both JWT standard (`sub`) and application-specific (`id`) fields
   - Added extensive logging to track authentication flows and failures
   - Enhanced robustness with better null checking and error reporting

4. **Frontend Authentication**:
   - Created centralized `call_with_auth` helper function for API calls 
   - Added `credentials: 'include'` to all API fetch calls to ensure cookies are sent with requests
   - Ensured localStorage token is explicitly set after MFA verification
   - Both cookie-based and Bearer token authentication now work in tandem
   - Improved error handling for all authentication API calls

## Security Considerations

- **Secret Storage**: TOTP secrets are stored securely in the database
- **Backup Code Security**: Backup codes are stored as SHA-256 hashes
- **One-time Use**: Backup codes are invalidated after a single use
- **Multi-factor Confirmation**: Disabling 2FA requires both password and verification code, ensuring that both factors must be proven before removing the security feature
- **Secure Cookies**: Authentication tokens are transmitted via secure, HttpOnly cookies
- **Constant-Time Operations**: Backup code verification uses constant-time comparison to prevent timing attacks
- **Generic Error Messages**: Authentication errors return standardized messages to prevent account enumeration
- **Detailed Logging**: Failed authentication attempts are logged with specific details for security monitoring
- **Consistent Error Handling**: All authentication flows use the same error patterns and messages

### Current Security Implementation

The implementation includes the following security features:

1. **Enhanced Logging**: Comprehensive logging for security monitoring:
   - All authentication attempts are logged with timestamps and source IP addresses
   - Failed attempts include specific details for security analysis
   - MFA-specific events (setup, verification, disabling) have detailed logs
   - Sensitive operations are logged with appropriate details

2. **Consistent Security Controls**: Uniform security measures across all sensitive endpoints:
   - Standard account login
   - MFA verification
   - Password updates
   - MFA management (setup, disabling, backup code regeneration)
   - Security-sensitive operations requiring password confirmation

3. **Admin MFA Management**: Admin functionality to manage MFA for users:
   - Admins can view MFA status for all users in the admin interface
   - Admins can disable MFA for any user account (helpful for account recovery)
   - MFA status is displayed in the user management table
   - All admin MFA operations are properly logged for security auditing

4. **Generic Error Messages**: All authentication failures return generic error messages to prevent account enumeration
   - Same error message is returned whether the email exists or not
   - Same error message for invalid credentials, regardless of whether the email or password is incorrect
   - Same error for MFA verification failures, whether TOTP or backup code is used

5. **Secure Token Handling**:
   - Secure, HttpOnly cookies for authentication tokens
   - JWT token validation with proper audience and issuer checks
   - Partial tokens for MFA verification process that cannot be reused

6. **Constant-Time Comparisons**:
   - Backup code verification uses constant-time comparison to prevent timing attacks
   - This prevents attackers from determining if a code is partially correct based on response times

### Security Limitations

The current implementation prioritizes correct 2FA functionality. Additional security improvements recommended:

1. **Rate Limiting**: Implementation of rate limiting on authentication endpoints
   - Global IP-based rate limiting for all authentication-related endpoints
   - Configurable rate limiting windows and maximum attempt thresholds
   - Different rate limits for standard authentication and MFA endpoints
   - Note: Rate limiting was temporarily removed to facilitate 2FA implementation and testing

2. **Account Lockout**: Implementation of a temporary account lockout system
   - Automatic account locking after multiple failed login attempts
   - Separate lockout tracking for different authentication operations
   - Configurable lockout duration with automatic unlocking

3. **TOTP Time Drift**: Server-side time drift correction for TOTP validation to reduce false negatives
4. **Comprehensive Audit System**: Enhanced security event logging with comprehensive audit trails
5. **Session Management**: Improved session lifetime management and revocation capabilities
6. **MFA Event Notifications**: Email notifications for critical MFA events (setup, disable, backup code use)
7. **Authentication Metrics**: Advanced metrics for failed authentication attempts to help detect attack patterns
8. **Token Expiration Controls**: Configurable lifetime for partial tokens used in MFA verification
